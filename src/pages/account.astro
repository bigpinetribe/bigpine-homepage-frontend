---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="My Account - Big Pine Paiute Tribe" showBanner={false}>
  <div id="loading" class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div id="account-content" style="display: none;">
    <h1>My Account</h1>

    <div class="row">
      <div class="col-lg-8">
        <div class="pop-section p-4">
          <h2>Account Information</h2>
          <table class="table">
            <tbody>
              <tr>
                <th>Email</th>
                <td id="user-email">-</td>
              </tr>
              <tr>
                <th>Member Since</th>
                <td id="user-created">-</td>
              </tr>
              <tr>
                <th>Last Sign In</th>
                <td id="user-last-signin">-</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pop-section p-4 mt-4">
          <h2>Member Services</h2>
          <p>Access tribal member services and resources:</p>
          <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <a href="/forms">Downloadable Forms</a>
            </li>
            <li class="list-group-item">
              <a href="/department/housing">Housing Services</a>
            </li>
            <li class="list-group-item">
              <a href="/department/education">Education Programs</a>
            </li>
          </ul>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="pop-section p-4">
          <h2>Quick Actions</h2>
          <div class="d-grid gap-2">
            <a href="/contact" class="btn btn-outline-primary">Contact Us</a>
            <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from "../lib/supabase";

    const loading = document.getElementById("loading") as HTMLDivElement;
    const accountContent = document.getElementById("account-content") as HTMLDivElement;
    const userEmail = document.getElementById("user-email") as HTMLTableCellElement;
    const userCreated = document.getElementById("user-created") as HTMLTableCellElement;
    const userLastSignin = document.getElementById("user-last-signin") as HTMLTableCellElement;
    const logoutBtn = document.getElementById("logout-btn") as HTMLButtonElement;

    async function checkAuth() {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = "/login";
        return;
      }

      const user = session.user;

      // Populate user info
      userEmail.textContent = user.email || "-";
      userCreated.textContent = user.created_at
        ? new Date(user.created_at).toLocaleDateString()
        : "-";
      userLastSignin.textContent = user.last_sign_in_at
        ? new Date(user.last_sign_in_at).toLocaleDateString()
        : "-";

      // Show content
      loading.style.display = "none";
      accountContent.style.display = "block";
    }

    logoutBtn?.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "/login";
    });

    checkAuth();
  </script>
</BaseLayout>
