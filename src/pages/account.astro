---
import BaseLayout from "../layouts/BaseLayout.astro";
---

<BaseLayout title="My Account - Big Pine Paiute Tribe" showBanner={false}>
  <div id="loading" class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div id="account-content" style="display: none;">
    <h1>My Account</h1>

    <div class="row">
      <div class="col-lg-8">
        <div class="pop-section p-4">
          <h2>Account Information</h2>
          <table class="table">
            <tbody>
              <tr>
                <th>Name</th>
                <td id="user-name">-</td>
              </tr>
              <tr>
                <th>Email</th>
                <td id="user-email">-</td>
              </tr>
              <tr>
                <th>Phone</th>
                <td id="user-phone">-</td>
              </tr>
              <tr>
                <th>Role</th>
                <td id="user-role">-</td>
              </tr>
              <tr>
                <th>Enrollment Number</th>
                <td id="user-enrollment">-</td>
              </tr>
              <tr>
                <th>Member Since</th>
                <td id="user-created">-</td>
              </tr>
              <tr>
                <th>Last Sign In</th>
                <td id="user-last-signin">-</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="pop-section p-4">
          <h2>Quick Actions</h2>
          <div class="d-grid gap-2">
            <a href="/contact" class="btn btn-outline-primary">Contact Us</a>
            <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    import { supabase } from "../lib/supabase";
    import type { UserProfile } from "../types/database";

    const loading = document.getElementById("loading") as HTMLDivElement;
    const accountContent = document.getElementById("account-content") as HTMLDivElement;
    const userName = document.getElementById("user-name") as HTMLTableCellElement;
    const userEmail = document.getElementById("user-email") as HTMLTableCellElement;
    const userPhone = document.getElementById("user-phone") as HTMLTableCellElement;
    const userRole = document.getElementById("user-role") as HTMLTableCellElement;
    const userEnrollment = document.getElementById("user-enrollment") as HTMLTableCellElement;
    const userCreated = document.getElementById("user-created") as HTMLTableCellElement;
    const userLastSignin = document.getElementById("user-last-signin") as HTMLTableCellElement;
    const logoutBtn = document.getElementById("logout-btn") as HTMLButtonElement;

    async function checkAuth() {
      const {
        data: { session },
      } = await supabase.auth.getSession();

      if (!session) {
        window.location.href = "/login";
        return;
      }

      const user = session.user;

      // Fetch user profile from user_profiles table
      const { data: profile, error: profileError } = await supabase
        .from("user_profiles")
        .select("*")
        .eq("id", user.id)
        .single();

      if (profileError) {
        console.error("Error fetching profile:", profileError);
      }

      const userProfile = profile as UserProfile | null;

      // Populate user info
      userName.textContent = userProfile 
        ? `${userProfile.first_name} ${userProfile.last_name}`
        : "-";
      userEmail.textContent = user.email || "-";
      userPhone.textContent = userProfile?.phone || "-";
      userRole.textContent = userProfile?.role 
        ? userProfile.role.charAt(0).toUpperCase() + userProfile.role.slice(1)
        : "-";
      userEnrollment.textContent = userProfile?.enrollment_number || "-";
      userCreated.textContent = user.created_at
        ? new Date(user.created_at).toLocaleDateString()
        : "-";
      userLastSignin.textContent = user.last_sign_in_at
        ? new Date(user.last_sign_in_at).toLocaleDateString()
        : "-";

      // Show content
      loading.style.display = "none";
      accountContent.style.display = "block";
    }

    logoutBtn?.addEventListener("click", async () => {
      await supabase.auth.signOut();
      window.location.href = "/login";
    });

    checkAuth();
  </script>
</BaseLayout>
