---
import { getDepartments, getGlobalSettings } from "../lib/content";
import "../styles/global.css";

interface Props {
  title?: string;
  showBanner?: boolean;
}

const { title = "Big Pine Paiute Tribe of the Owens Valley", showBanner = true } = Astro.props;
const currentYear = new Date().getFullYear();

const departments = await getDepartments();
const settings = await getGlobalSettings();
---

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css"
    />
  </head>
  <body class="d-flex flex-column min-vh-100">
    <!-- Navbar -->
    <header>
      <nav class="navbar navbar-large navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
          <a class="navbar-brand" href="/">
            <div class="row no-gutters align-items-center">
              <div class="col">
                <img
                  src="/img/big_pine_seal_220.png"
                  id="navbar-logo"
                  alt="logo"
                  width="60"
                  height="60"
                  class="d-inline-block align-top"
                />
              </div>
              <div class="col d-none d-lg-inline">
                Big Pine Paiute Tribe of the Owens Valley
              </div>
            </div>
          </a>
          <button
            class="navbar-toggler ms-auto"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarNav"
            aria-controls="navbarNav"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse ml-auto" id="navbarNav">
            <ul class="navbar-nav ms-auto">
              <li class="nav-item">
                <a class="nav-link" href="/">Home</a>
              </li>
              <li class="nav-item dropdown">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="departmentsDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  Departments
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="departmentsDropdown">
                  {
                    departments.map((dept) => (
                      <li>
                        <a class="dropdown-item bg-light" href={`/department/${dept.slug}`}>
                          {dept.name}
                        </a>
                      </li>
                    ))
                  }
                </ul>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/news">News & Events</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/contact">Contact Us</a>
              </li>
              <li class="nav-item" id="auth-nav-item-guest" style="display: none;">
                <a class="nav-link" href="/login">Login</a>
              </li>
              <li class="nav-item dropdown" id="auth-nav-item-user" style="display: none;">
                <a
                  class="nav-link dropdown-toggle"
                  href="#"
                  id="accountDropdown"
                  role="button"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  <i class="fas fa-user-circle"></i> <span id="user-name-nav">Account</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="accountDropdown">
                  <li>
                    <a class="dropdown-item" href="/members/">
                      <i class="fas fa-id-card"></i> Member Services
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="/account">
                      <i class="fas fa-user"></i> My Account
                    </a>
                  </li>
                  <li><hr class="dropdown-divider" /></li>
                  <li>
                    <a class="dropdown-item" href="#" id="nav-logout-btn">
                      <i class="fas fa-sign-out-alt"></i> Logout
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <main role="main" class="flex-fill">
      {
        showBanner && (
          <div class="container-fluid">
            <img
              src="/img/Sierra_Nevada_as_seen_from_Big_Pine_wide.jpg"
              class="img-fluid"
              alt="Banner"
              style="width: 100%; height: auto;"
            />
          </div>
        )
      }
      <div class="container my-4">
        <slot />
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-light text-center text-lg-start py-2">
      <div class="container-fluid">
        <div class="row">
          <div class="col-12 col-lg-2 my-1 text-center text-lg-start">
            <a class="navbar-brand mx-auto" href="#">
              <img
                src="/img/big_pine_seal_220.png"
                alt="logo"
                width="60"
                class="d-inline-block align-top"
              />
            </a>
          </div>
          <div
            class="col-12 col-lg-8 my-1 text-center text-lg-middle"
            style="display: flex; flex-direction: column; justify-content: center; align-items: center;"
          >
            &copy; {currentYear} Big Pine Paiute Tribe of the Owens Valley.
          </div>
          <div class="col-12 col-lg-2 my-1 pt-3 text-lg-end">
            {settings.facebookUrl && (
              <a href={settings.facebookUrl} class="mx-1">
                <i class="fab fa-facebook fa-2x" style="color:gray;"></i>
              </a>
            )}
          </div>
        </div>
      </div>
    </footer>

    <!-- Scripts -->
    <script
      defer
      src="https://use.fontawesome.com/releases/v5.15.4/js/all.js"
      integrity="sha384-rOA1PnstxnOBLzCLMcre8ybwbTmemjzdNlILg8O7z1lUkLXozs4DHonlDtnE7fpc"
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>
    <script>
      // Navbar scroll behavior
      window.addEventListener("scroll", function () {
        const navbar = document.querySelector(".navbar");
        if (window.scrollY > 50) {
          navbar?.classList.remove("navbar-large");
          navbar?.classList.add("navbar-small");
        } else {
          navbar?.classList.remove("navbar-small");
          navbar?.classList.add("navbar-large");
        }
      });
    </script>
    <script>
      import { supabase } from "../lib/supabase";
      
      // Check authentication state and update navigation
      async function updateNavAuth() {
        const guestNav = document.getElementById("auth-nav-item-guest");
        const userNav = document.getElementById("auth-nav-item-user");
        const userNameNav = document.getElementById("user-name-nav");
        const logoutBtn = document.getElementById("nav-logout-btn");
        
        const { data: { session } } = await supabase.auth.getSession();
        
        if (session) {
          // User is logged in
          if (guestNav) guestNav.style.display = "none";
          if (userNav) userNav.style.display = "block";
          
          // Fetch user profile to get name
          const { data: profile } = await supabase
            .from("user_profiles")
            .select("first_name")
            .eq("id", session.user.id)
            .single();
          
          if (profile && userNameNav) {
            userNameNav.textContent = profile.first_name;
          }
        } else {
          // User is not logged in
          if (guestNav) guestNav.style.display = "block";
          if (userNav) userNav.style.display = "none";
        }
        
        // Handle logout
        logoutBtn?.addEventListener("click", async (e) => {
          e.preventDefault();
          await supabase.auth.signOut();
          window.location.href = "/";
        });
      }
      
      updateNavAuth();
    </script>
    <slot name="scripts" />
  </body>
</html>
